<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    console.log("jQuery loaded:", typeof jQuery); // Verifica che jQuery sia caricato
    $(document).ready(function() {
        console.log("Document ready!");
        caricaCarrello();
    });




// Funzione per caricare il carrello
function caricaCarrello() {
    $.ajax({
        url: 'api/prenotazioni/cart-query.php',
        method: 'GET', // Metodo GET per ottenere i dati
        dataType: 'json', // I dati sono in formato JSON
        success: function (data) {
            // Svuota il contenitore degli item del carrello esistenti
            $("#carrello-container").empty();

            // Variabili per il totale
            let totale = 0;
            let commissioni = 0;

            // Itera sui dati ricevuti e popola la pagina
            data.forEach(function (item) {
                const itemHTML = `
                    <div class="item-container" id="item-${item.idPrenotazione}">
                        <div class="container-img">
                            <img src="${item.pathFotoLocandina}" alt="Locandina">
                            <div class="concert-info">
                                <h1>${item.nomeEvento}</h1>
                                <p>${item.citta}</p>
                                <p>${item.dataOraEvento}</p>
                            </div>
                        </div>
                        <div class="timer-container">
                            <p id="timer-${item.idPrenotazione}">Caricando...</p>
                        </div>
                        <div class="posto-container">
                            <p>${item.nomeSettore}</p>
                        </div>
                        <div class="price-container">
                            <p>€${item.prezzo}</p>
                            <i class="fa-solid fa-trash-can" onclick="rimuoviElemento(${item.idPrenotazione})"></i>
                        </div>
                    </div>
                `;
                $("#carrello-container").append(itemHTML);

                // Aggiungi al totale
                totale += parseFloat(item.prezzo);
                commissioni += parseFloat(item.prezzo);  // Aggiusta in base alla logica delle commissioni

                // Calcolo il tempo rimanente
                const dataAggiunta = new Date(item.dataAggiunta);  // Converte la stringa in un oggetto Date
                const oraCorrente = new Date();
                const tempoRimanente = dataAggiunta.getTime() + (24 * 60 * 60 * 1000) - oraCorrente.getTime();  // 24 ore in millisecondi

                // Funzione per gestire il timer
                function aggiornaTimer() {
                    if (tempoRimanente <= 0) {
                        rimuoviElemento(item.idPrenotazione);
                    } else {
                        const ore = Math.floor(tempoRimanente / (1000 * 60 * 60));
                        const minuti = Math.floor((tempoRimanente % (1000 * 60 * 60)) / (1000 * 60));
                        const secondi = Math.floor((tempoRimanente % (1000 * 60)) / 1000);
                        $("#timer-" + item.idPrenotazione).text(`${ore}h ${minuti}m ${secondi}s`);
                    }
                }

                // Chiamare la funzione ogni secondo per aggiornare il timer
                const interval = setInterval(function () {
                    aggiornaTimer();
                }, 1000);

                // Popola il totale, le commissioni e il gran totale
                $("#totale").text(`€${totale.toFixed(2)}`);
                $("#commissioni").text(`€${commissioni.toFixed(2)}`);
                $("#grantotale").text(`€${(totale + commissioni).toFixed(2)}`);
            });
        },
        error: function (xhr, status, error) {
            console.log("Errore nel caricare i dati del carrello", xhr.responseText);
        }
    });
}

// Funzione per rimuovere un elemento dal carrello
function rimuoviElemento(idPrenotazione) {
    $.ajax({
        url: 'api/prenotazioni/remove-item.php',
        method: 'POST',
        data: { idPrenotazione: idPrenotazione },
        success: function (response) {
            if (response.success) {
                // Rimuove l'elemento dal carrello visibile
                $(`#item-${idPrenotazione}`).remove();
                caricaCarrello(); // Ricarica il carrello
            } else {
                alert("Errore nella rimozione dell'elemento");
            }
        },
        error: function (error) {
            console.log("Errore nella rimozione dell'elemento", error);
        }
    });
}

</script>